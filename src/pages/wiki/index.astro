---
/**
 * Wiki Index - Lexikon-Übersicht mit A-Z Navigation
 */
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/layout/Header.astro';
import Footer from '../../components/layout/Footer.astro';
import Breadcrumbs from '../../components/layout/Breadcrumbs.astro';
import Tag from '../../components/ui/Tag.astro';
import { getCollection } from 'astro:content';
import { localePath, type Locale } from '../../i18n/translations';

const locale = (Astro.locals.locale || 'de') as Locale;
const lp = (path: string) => localePath(path, locale);
const contentLocale = locale === 'de' ? 'de' : 'en';

// Alle Wiki-Einträge laden
const allEntries = await getCollection('wiki');

const localizedEntries = allEntries.filter((entry) => {
  if (contentLocale === 'de') {
    return !entry.id.startsWith('en/');
  }
  return entry.id.startsWith('en/');
});

// Alphabetisch sortieren
const entries = localizedEntries.sort((a, b) =>
  a.data.term.localeCompare(b.data.term, locale)
);

// Nach Anfangsbuchstaben gruppieren
const groupedEntries = entries.reduce((acc, entry) => {
  const letter = entry.data.term[0].toUpperCase();
  if (!acc[letter]) acc[letter] = [];
  acc[letter].push(entry);
  return acc;
}, {} as Record<string, typeof entries>);

// Alle Buchstaben A-Z
const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
const availableLetters = Object.keys(groupedEntries);

// Kategorien
const categories = [...new Set(entries.map(e => e.data.category))];

const content = {
  de: {
    title: 'CT-Lexikon',
    subtitle: 'Fachbegriffe der industriellen Computertomographie verständlich erklärt',
    search: 'Begriff suchen...',
    categories: 'Kategorien',
    allCategories: 'Alle',
    noEntries: 'Noch keine Einträge vorhanden.',
    entries: 'Einträge',
    categoryLabels: {
      'grundlagen': 'CT-Grundlagen',
      'verfahren': 'Verfahren',
      'qm': 'Qualitätsmanagement',
      'materialien': 'Materialien',
      'normen': 'Normen & Standards',
      'software': 'Software',
      'hardware': 'Hardware',
      'allgemein': 'Allgemein'
    }
  },
  en: {
    title: 'CT Glossary',
    subtitle: 'Industrial computed tomography terms explained clearly',
    search: 'Search term...',
    categories: 'Categories',
    allCategories: 'All',
    noEntries: 'No entries yet.',
    entries: 'entries',
    categoryLabels: {
      'grundlagen': 'CT Basics',
      'verfahren': 'Methods',
      'qm': 'Quality Management',
      'materialien': 'Materials',
      'normen': 'Standards',
      'software': 'Software',
      'hardware': 'Hardware',
      'allgemein': 'General'
    }
  },
  fr: {
    title: 'Glossaire CT',
    subtitle: 'Termes de la tomographie industrielle expliqués clairement',
    search: 'Rechercher un terme...',
    categories: 'Catégories',
    allCategories: 'Tous',
    noEntries: 'Aucune entrée pour le moment.',
    entries: 'entrées',
    categoryLabels: {
      'grundlagen': 'Bases CT',
      'verfahren': 'Méthodes',
      'qm': 'Management qualité',
      'materialien': 'Matériaux',
      'normen': 'Normes',
      'software': 'Logiciel',
      'hardware': 'Matériel',
      'allgemein': 'Général'
    }
  },
  es: {
    title: 'Glosario CT',
    subtitle: 'Términos de tomografía industrial explicados claramente',
    search: 'Buscar término...',
    categories: 'Categorías',
    allCategories: 'Todos',
    noEntries: 'Aún no hay entradas.',
    entries: 'entradas',
    categoryLabels: {
      'grundlagen': 'Fundamentos CT',
      'verfahren': 'Métodos',
      'qm': 'Gestión de calidad',
      'materialien': 'Materiales',
      'normen': 'Normas',
      'software': 'Software',
      'hardware': 'Hardware',
      'allgemein': 'General'
    }
  },
  it: {
    title: 'Glossario CT',
    subtitle: 'Termini della tomografia industriale spiegati chiaramente',
    search: 'Cerca termine...',
    categories: 'Categorie',
    allCategories: 'Tutti',
    noEntries: 'Nessuna voce per ora.',
    entries: 'voci',
    categoryLabels: {
      'grundlagen': 'Fondamenti CT',
      'verfahren': 'Metodi',
      'qm': 'Gestione qualità',
      'materialien': 'Materiali',
      'normen': 'Norme',
      'software': 'Software',
      'hardware': 'Hardware',
      'allgemein': 'Generale'
    }
  }
};

const t = content[locale as keyof typeof content] || content.en || content.de;
---

<BaseLayout
  title={t.title}
  description={t.subtitle}
>
  <Header slot="header" />

  <div class="container">
    <Breadcrumbs items={[
      { label: t.title }
    ]} />

    <!-- Hero -->
    <section class="page-hero">
      <h1>{t.title}</h1>
      <p class="subtitle">{t.subtitle}</p>

      <!-- Search -->
      <div class="search-box">
        <input
          type="search"
          id="wiki-search"
          placeholder={t.search}
          aria-label={t.search}
        />
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"/>
          <path d="m21 21-4.3-4.3"/>
        </svg>
      </div>
    </section>

    <!-- Category Filter -->
    <nav class="category-filter">
      <Tag href={lp('/wiki')} variant="primary">{t.allCategories}</Tag>
      {categories.map(cat => (
        <Tag href={lp(`/wiki/kategorie/${cat}`)} variant="default">
          {t.categoryLabels[cat as keyof typeof t.categoryLabels] || cat}
        </Tag>
      ))}
    </nav>

    <!-- A-Z Navigation -->
    <nav class="az-nav" aria-label="Alphabetische Navigation">
      {alphabet.map(letter => (
        <a
          href={availableLetters.includes(letter) ? `#letter-${letter}` : undefined}
          class:list={[
            'az-letter',
            { 'disabled': !availableLetters.includes(letter) }
          ]}
          aria-disabled={!availableLetters.includes(letter)}
        >
          {letter}
        </a>
      ))}
    </nav>

    {entries.length === 0 ? (
      <div class="empty-state">
        <p>{t.noEntries}</p>
      </div>
    ) : (
      <div class="wiki-content">
        {Object.entries(groupedEntries).sort().map(([letter, letterEntries]) => (
          <section class="letter-section" id={`letter-${letter}`}>
            <h2 class="letter-heading">{letter}</h2>
            <div class="entries-list">
              {letterEntries.map(entry => (
                <a href={lp(`/wiki/${entry.slug}`)} class="wiki-entry">
                  <div class="entry-main">
                    <h3>{entry.data.term}</h3>
                    <p>{entry.data.definition}</p>
                  </div>
                  <Tag variant="default" size="sm">
                    {t.categoryLabels[entry.data.category as keyof typeof t.categoryLabels]}
                  </Tag>
                </a>
              ))}
            </div>
          </section>
        ))}
      </div>
    )}

    <!-- Stats -->
    <div class="wiki-stats">
      <span>{entries.length} {t.entries}</span>
    </div>
  </div>

  <Footer slot="footer" />
</BaseLayout>

<style>
  .page-hero {
    text-align: center;
    padding: var(--space-12) 0;
    max-width: 700px;
    margin: 0 auto;
  }

  .page-hero h1 {
    font-size: var(--text-5xl);
    margin-bottom: var(--space-4);
  }

  .subtitle {
    font-size: var(--text-xl);
    color: var(--text-muted);
    margin-bottom: var(--space-8);
  }

  .search-box {
    position: relative;
    max-width: 400px;
    margin: 0 auto;
  }

  .search-box input {
    width: 100%;
    padding: var(--space-3) var(--space-4) var(--space-3) var(--space-12);
    border: 1px solid var(--border);
    border-radius: var(--radius-full);
    font-size: var(--text-base);
    background: var(--surface);
    transition: all var(--transition-fast);
  }

  .search-box input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
  }

  .search-box svg {
    position: absolute;
    left: var(--space-4);
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-muted);
  }

  .category-filter {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
    justify-content: center;
    padding: var(--space-6) 0;
    border-bottom: 1px solid var(--border);
  }

  .az-nav {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: var(--space-1);
    padding: var(--space-6) 0;
    border-bottom: 1px solid var(--border);
    margin-bottom: var(--space-8);
  }

  .az-letter {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    font-weight: 600;
    color: var(--text);
    text-decoration: none;
    border-radius: var(--radius-md);
    transition: all var(--transition-fast);
  }

  .az-letter:hover:not(.disabled) {
    background: var(--primary);
    color: white;
  }

  .az-letter.disabled {
    color: var(--text-muted);
    opacity: 0.4;
    cursor: default;
  }

  .empty-state {
    text-align: center;
    padding: var(--space-20) 0;
    color: var(--text-muted);
  }

  .letter-section {
    margin-bottom: var(--space-12);
    scroll-margin-top: var(--space-20);
  }

  .letter-heading {
    font-size: var(--text-3xl);
    color: var(--primary);
    padding-bottom: var(--space-4);
    border-bottom: 2px solid var(--primary);
    margin-bottom: var(--space-6);
  }

  .entries-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
  }

  .wiki-entry {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: var(--space-4);
    padding: var(--space-4);
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    text-decoration: none;
    color: inherit;
    transition: all var(--transition-fast);
  }

  .wiki-entry:hover {
    border-color: var(--primary);
    box-shadow: var(--shadow-sm);
  }

  .entry-main {
    flex: 1;
  }

  .wiki-entry h3 {
    color: var(--text);
    margin-bottom: var(--space-1);
    transition: color var(--transition-fast);
  }

  .wiki-entry:hover h3 {
    color: var(--primary);
  }

  .wiki-entry p {
    color: var(--text-muted);
    font-size: var(--text-sm);
    margin: 0;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .wiki-stats {
    text-align: center;
    padding: var(--space-8) 0;
    color: var(--text-muted);
    font-size: var(--text-sm);
  }
</style>

<script>
  // Simple client-side search
  const searchInput = document.getElementById('wiki-search') as HTMLInputElement;
  const entries = document.querySelectorAll('.wiki-entry');
  const sections = document.querySelectorAll('.letter-section');

  searchInput?.addEventListener('input', (e) => {
    const query = (e.target as HTMLInputElement).value.toLowerCase();

    entries.forEach(entry => {
      const term = entry.querySelector('h3')?.textContent?.toLowerCase() || '';
      const definition = entry.querySelector('p')?.textContent?.toLowerCase() || '';
      const matches = term.includes(query) || definition.includes(query);
      (entry as HTMLElement).style.display = matches ? 'flex' : 'none';
    });

    // Hide empty sections
    sections.forEach(section => {
      const visibleEntries = section.querySelectorAll('.wiki-entry[style="display: flex"], .wiki-entry:not([style])');
      const hasVisible = Array.from(section.querySelectorAll('.wiki-entry')).some(
        e => (e as HTMLElement).style.display !== 'none'
      );
      (section as HTMLElement).style.display = hasVisible ? 'block' : 'none';
    });
  });
</script>
