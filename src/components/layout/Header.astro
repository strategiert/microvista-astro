---
/**
 * Globaler Header - Wird auf allen Seiten angezeigt
 * Responsive Navigation mit Mobile Menu - 5 Sprachen
 */
import { translations, localeNames, type Locale, localePath } from '../../i18n/translations';

interface Props {
  theme?: 'light' | 'dark' | 'transparent';
}

const { theme = 'light' } = Astro.props;
const locale = (Astro.currentLocale || 'de') as Locale;

const lp = (path: string) => localePath(path, locale);

const nav = translations.nav;
const laborNav = translations.laborNav;
const serieNav = translations.serieNav;

// Alle verfügbaren Sprachen
const locales: Locale[] = ['de', 'en', 'fr', 'es', 'it'];

// Get current path without locale prefix for language switching
const currentPath = Astro.url.pathname;
const pathWithoutLocale = locale === 'de'
  ? currentPath
  : currentPath.replace(new RegExp(`^/${locale}`), '') || '/';

// Helper to build language-specific URL preserving current path
const getLangUrl = (targetLocale: Locale) => {
  return targetLocale === 'de' ? pathWithoutLocale : `/${targetLocale}${pathWithoutLocale}`;
};
---

<header class:list={['site-header', `theme-${theme}`]}>
  <div class="container">
    <a href={lp('/')} class="logo">
      <div class="logo-mark">M</div>
      <span class="logo-text">Microvista</span>
    </a>

    <nav class="main-nav" id="main-nav">
      <ul class="nav-list">
        <li class="nav-item has-dropdown">
          <a href={lp('/labor')}>{nav.labor[locale]}</a>
          <ul class="dropdown">
            <li><a href={lp('/labor/erstmusterpruefung')}>{laborNav.erstmusterpruefung[locale]}</a></li>
            <li><a href={lp('/labor/schadensanalyse')}>{laborNav.schadensanalyse[locale]}</a></li>
            <li><a href={lp('/labor/reverse-engineering')}>{laborNav.reverseEngineering[locale]}</a></li>
          </ul>
        </li>
        <li class="nav-item has-dropdown">
          <a href={lp('/serie')}>{nav.serie[locale]}</a>
          <ul class="dropdown">
            <li><a href={lp('/serie/inline-ct')}>{serieNav.inlineCt[locale]}</a></li>
            <li><a href={lp('/serie/100-prozent-pruefung')}>{serieNav.hundertProzent[locale]}</a></li>
            <li><a href={lp('/serie/ki-automatisierung')}>{serieNav.kiAutomatisierung[locale]}</a></li>
          </ul>
        </li>
        <li class="nav-item"><a href={lp('/branchen')}>{nav.branchen[locale]}</a></li>
        <li class="nav-item"><a href={lp('/magazin')}>{nav.magazin[locale]}</a></li>
        <li class="nav-item"><a href={lp('/wiki')}>{nav.wiki[locale]}</a></li>
      </ul>
    </nav>

    <div class="header-actions">
      <!-- Language Switcher -->
      <div class="lang-switch-wrapper">
        <button class="lang-current" aria-expanded="false" aria-haspopup="true">
          {locale.toUpperCase()}
          <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="6 9 12 15 18 9"/>
          </svg>
        </button>
        <ul class="lang-dropdown">
          {locales.map(l => (
            <li>
              <a
                href={getLangUrl(l)}
                class:list={[{ active: l === locale }]}
              >
                <span class="lang-code">{l.toUpperCase()}</span>
                <span class="lang-name">{localeNames[l]}</span>
              </a>
            </li>
          ))}
        </ul>
      </div>

      <a href={lp('/kontakt')} class="btn btn-primary btn-sm">{nav.kontakt[locale]}</a>

      <button class="mobile-menu-toggle" aria-label="Menü öffnen" aria-expanded="false">
        <span class="hamburger"></span>
      </button>
    </div>
  </div>
</header>

<style>
  .site-header {
    position: sticky;
    top: 0;
    z-index: 100;
    background: var(--background);
    border-bottom: 1px solid var(--border);
    padding: var(--space-4) 0;
  }

  .site-header.theme-transparent {
    position: absolute;
    left: 0;
    right: 0;
    background: transparent;
    border-bottom: none;
  }

  .site-header.theme-dark {
    background: var(--primary);
    border-bottom-color: rgba(255,255,255,0.1);
  }

  .site-header .container {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--space-8);
  }

  .logo {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    text-decoration: none;
    color: var(--text);
  }

  .theme-dark .logo,
  .theme-transparent .logo {
    color: white;
  }

  .logo-mark {
    width: 36px;
    height: 36px;
    border-radius: var(--radius-lg);
    background: linear-gradient(135deg, #7C3AED, #00B4D8);
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: var(--font-heading);
    font-weight: 700;
    font-size: var(--text-lg);
    color: white;
  }

  .logo-text {
    font-family: var(--font-heading);
    font-size: var(--text-xl);
    font-weight: 700;
  }

  .main-nav {
    flex: 1;
    display: flex;
    justify-content: center;
  }

  .nav-list {
    display: flex;
    gap: var(--space-1);
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .nav-item > a {
    display: block;
    padding: var(--space-2) var(--space-4);
    color: var(--text-muted);
    text-decoration: none;
    font-weight: 500;
    border-radius: var(--radius-md);
    transition: all var(--transition-fast);
  }

  .theme-dark .nav-item > a,
  .theme-transparent .nav-item > a {
    color: rgba(255,255,255,0.7);
  }

  .nav-item > a:hover {
    color: var(--text);
    background: var(--surface);
  }

  .theme-dark .nav-item > a:hover,
  .theme-transparent .nav-item > a:hover {
    color: white;
    background: rgba(255,255,255,0.1);
  }

  /* Dropdown */
  .has-dropdown {
    position: relative;
  }

  .dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    min-width: 220px;
    background: var(--background);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    padding: var(--space-2);
    opacity: 0;
    visibility: hidden;
    transform: translateY(8px);
    transition: all var(--transition-fast);
    list-style: none;
    margin: 0;
  }

  .has-dropdown:hover .dropdown {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .dropdown a {
    display: block;
    padding: var(--space-2) var(--space-3);
    color: var(--text-muted);
    text-decoration: none;
    border-radius: var(--radius-md);
    font-size: var(--text-sm);
  }

  .dropdown a:hover {
    color: var(--text);
    background: var(--surface);
  }

  .header-actions {
    display: flex;
    align-items: center;
    gap: var(--space-4);
  }

  /* Language Switcher */
  .lang-switch-wrapper {
    position: relative;
  }

  .lang-current {
    display: flex;
    align-items: center;
    gap: var(--space-1);
    padding: var(--space-2) var(--space-3);
    background: none;
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    color: var(--text);
    font-size: var(--text-sm);
    font-weight: 500;
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .lang-current:hover {
    border-color: var(--primary);
  }

  .theme-dark .lang-current,
  .theme-transparent .lang-current {
    border-color: rgba(255,255,255,0.2);
    color: white;
  }

  .lang-dropdown {
    position: absolute;
    top: 100%;
    right: 0;
    margin-top: var(--space-2);
    min-width: 160px;
    background: var(--background);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    padding: var(--space-2);
    list-style: none;
    opacity: 0;
    visibility: hidden;
    transform: translateY(8px);
    transition: all var(--transition-fast);
  }

  .lang-switch-wrapper:hover .lang-dropdown,
  .lang-current[aria-expanded="true"] + .lang-dropdown {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .lang-dropdown a {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-2) var(--space-3);
    color: var(--text-muted);
    text-decoration: none;
    border-radius: var(--radius-md);
    transition: all var(--transition-fast);
  }

  .lang-dropdown a:hover,
  .lang-dropdown a.active {
    color: var(--text);
    background: var(--surface);
  }

  .lang-dropdown a.active {
    font-weight: 600;
  }

  .lang-code {
    font-weight: 600;
    font-size: var(--text-sm);
  }

  .lang-name {
    font-size: var(--text-sm);
    color: var(--text-muted);
  }

  .mobile-menu-toggle {
    display: none;
    padding: var(--space-2);
    background: none;
    border: none;
    cursor: pointer;
  }

  .hamburger {
    display: block;
    width: 24px;
    height: 2px;
    background: var(--text);
    position: relative;
  }

  .hamburger::before,
  .hamburger::after {
    content: '';
    position: absolute;
    width: 100%;
    height: 100%;
    background: inherit;
    left: 0;
  }

  .hamburger::before { top: -7px; }
  .hamburger::after { top: 7px; }

  .theme-dark .hamburger,
  .theme-transparent .hamburger {
    background: white;
  }

  /* Mobile */
  @media (max-width: 1024px) {
    .main-nav {
      display: none;
    }

    .mobile-menu-toggle {
      display: block;
    }

    .header-actions .btn {
      display: none;
    }
  }
</style>

<script>
  // Mobile menu toggle
  const toggle = document.querySelector('.mobile-menu-toggle');
  const nav = document.getElementById('main-nav');

  toggle?.addEventListener('click', () => {
    const isExpanded = toggle.getAttribute('aria-expanded') === 'true';
    toggle.setAttribute('aria-expanded', (!isExpanded).toString());
    nav?.classList.toggle('is-open');
  });

  // Language dropdown
  const langBtn = document.querySelector('.lang-current');
  langBtn?.addEventListener('click', () => {
    const isExpanded = langBtn.getAttribute('aria-expanded') === 'true';
    langBtn.setAttribute('aria-expanded', (!isExpanded).toString());
  });
</script>
