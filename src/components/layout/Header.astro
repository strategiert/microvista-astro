---
/**
 * Globaler Header - Wird auf allen Seiten angezeigt
 * Responsive Navigation mit Mobile Menu - 5 Sprachen
 */
import {
  translations,
  localeNames,
  type Locale,
  localePath,
  enabledLocales,
  languageSwitchPath
} from '../../i18n/translations';

interface Props {
  theme?: 'light' | 'dark' | 'transparent';
  world?: 'labor' | 'serie';
}

const { theme = 'light', world } = Astro.props;
const locale = (Astro.locals.locale || 'de') as Locale;

const lp = (path: string) => localePath(path, locale);

const nav = translations.nav;
const laborNav = translations.laborNav;
const serieNav = translations.serieNav;

// Kontext-Leiste: Labor- und Serie-spezifische Sub-Links
const worldContext = {
  labor: {
    label: { de: 'Labor & Erstmuster', en: 'Lab & First Article', fr: 'Laboratoire', es: 'Laboratorio', it: 'Laboratorio' },
    links: [
      { de: 'Erstmusterprüfung', en: 'First Article Inspection', fr: 'Premier article', es: 'Primera muestra', it: 'Primo campione', href: '/labor/erstmusterpruefung' },
      { de: 'Schadensanalyse', en: 'Failure Analysis', fr: 'Analyse de défaillance', es: 'Análisis de fallas', it: 'Analisi dei guasti', href: '/labor/schadensanalyse' },
      { de: 'Reverse Engineering', en: 'Reverse Engineering', fr: 'Rétro-ingénierie', es: 'Ingeniería inversa', it: 'Reverse engineering', href: '/labor/reverse-engineering' },
    ],
    switch: { de: 'Zur Serienprüfung →', en: 'To Series Inspection →', fr: 'Vers l\'inspection série →', es: 'A inspección en serie →', it: 'All\'ispezione in serie →' },
    switchHref: '/serie',
  },
  serie: {
    label: { de: 'Serienprüfung', en: 'Series Inspection', fr: 'Inspection en série', es: 'Inspección en serie', it: 'Ispezione in serie' },
    links: [
      { de: 'Inline-CT', en: 'Inline CT', fr: 'CT en ligne', es: 'CT en línea', it: 'CT in linea', href: '/serie/inline-ct' },
      { de: '100% Prüfung', en: '100% Inspection', fr: 'Inspection 100%', es: 'Inspección 100%', it: 'Ispezione 100%', href: '/serie/100-prozent-pruefung' },
      { de: 'KI-Automatisierung', en: 'AI Automation', fr: 'Automatisation IA', es: 'Automatización IA', it: 'Automazione IA', href: '/serie/ki-automatisierung' },
    ],
    switch: { de: 'Zum Labor →', en: 'To the Lab →', fr: 'Vers le laboratoire →', es: 'Al laboratorio →', it: 'Al laboratorio →' },
    switchHref: '/labor',
  },
};

const worldCtx = world ? worldContext[world] : null;

// Aktueller Pfad für Sprachwechsel
const currentPath = Astro.url.pathname;

// Helper to build language-specific URL preserving current path
const getLangUrl = (targetLocale: Locale) => {
  return languageSwitchPath(currentPath, targetLocale);
};
---

<header class:list={['site-header', `theme-${theme}`]}>
  <div class="container">
    <a href={lp('/')} class="logo" aria-label="Microvista">
      <img
        class="logo-image logo-image-light"
        src="/images/logos/2013-08-microvista_Logo_RGB-7.png"
        alt="Microvista"
        width="705"
        height="399"
        loading="eager"
      />
      <img
        class="logo-image logo-image-dark"
        src="/images/logos/2024_08-MV-Logo_weiss.png"
        alt=""
        aria-hidden="true"
        width="705"
        height="399"
        loading="eager"
      />
    </a>

    <nav class="main-nav" id="main-nav">
      <ul class="nav-list">
        <li class="nav-item has-dropdown">
          <a href={lp('/labor')}>{nav.labor[locale]}</a>
          <ul class="dropdown">
            <li><a href={lp('/labor/erstmusterpruefung')}>{laborNav.erstmusterpruefung[locale]}</a></li>
            <li><a href={lp('/labor/schadensanalyse')}>{laborNav.schadensanalyse[locale]}</a></li>
            <li><a href={lp('/labor/reverse-engineering')}>{laborNav.reverseEngineering[locale]}</a></li>
          </ul>
        </li>
        <li class="nav-item has-dropdown">
          <a href={lp('/serie')}>{nav.serie[locale]}</a>
          <ul class="dropdown">
            <li><a href={lp('/serie/inline-ct')}>{serieNav.inlineCt[locale]}</a></li>
            <li><a href={lp('/serie/100-prozent-pruefung')}>{serieNav.hundertProzent[locale]}</a></li>
            <li><a href={lp('/serie/ki-automatisierung')}>{serieNav.kiAutomatisierung[locale]}</a></li>
          </ul>
        </li>
        <li class="nav-item"><a href={lp('/branchen')}>{nav.branchen[locale]}</a></li>
        <li class="nav-item"><a href={lp('/magazin')}>{nav.magazin[locale]}</a></li>
        <li class="nav-item"><a href={lp('/wiki')}>{nav.wiki[locale]}</a></li>
      </ul>
    </nav>

    <div class="header-actions">
      <!-- Language Switcher -->
      <div class="lang-switch-wrapper">
        <button class="lang-current" aria-expanded="false" aria-haspopup="true">
          {locale.toUpperCase()}
          <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="6 9 12 15 18 9"/>
          </svg>
        </button>
        <ul class="lang-dropdown">
          {enabledLocales.map(l => (
            <li>
              <a
                href={getLangUrl(l)}
                class:list={[{ active: l === locale }]}
              >
                <span class="lang-code">{l.toUpperCase()}</span>
                <span class="lang-name">{localeNames[l]}</span>
              </a>
            </li>
          ))}
        </ul>
      </div>

      <a href={lp('/kontakt')} class="btn btn-primary btn-sm">{nav.kontakt[locale]}</a>

      <button class="mobile-menu-toggle" aria-label="Menü öffnen" aria-expanded="false">
        <span class="hamburger"></span>
      </button>
    </div>
  </div>
</header>

{worldCtx && (
  <nav class:list={['world-bar', `world-bar--${world}`]} aria-label="Bereich-Navigation">
    <div class="container">
      <span class="world-bar__label">
        {worldCtx.label[locale as keyof typeof worldCtx.label] || worldCtx.label.en}
      </span>
      <span class="world-bar__sep" aria-hidden="true">›</span>
      <ul class="world-bar__links">
        {worldCtx.links.map(link => (
          <li>
            <a href={lp(link.href)}>
              {link[locale as keyof typeof link] as string || link.en}
            </a>
          </li>
        ))}
      </ul>
      <a href={lp(worldCtx.switchHref)} class="world-bar__switch">
        {worldCtx.switch[locale as keyof typeof worldCtx.switch] || worldCtx.switch.en}
      </a>
    </div>
  </nav>
)}

<style>
  .site-header {
    position: sticky;
    top: 0;
    z-index: 100;
    background: var(--background);
    border-bottom: 1px solid var(--border);
    padding: var(--space-4) 0;
  }

  .site-header.theme-transparent {
    position: absolute;
    left: 0;
    right: 0;
    background: transparent;
    border-bottom: none;
  }

  .site-header.theme-dark {
    background: var(--primary);
    border-bottom-color: rgba(255,255,255,0.1);
  }

  .site-header .container {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--space-8);
  }

  .logo {
    display: inline-flex;
    align-items: center;
    text-decoration: none;
    min-height: 40px;
  }

  .logo-image {
    display: block;
    width: auto;
    height: 42px;
  }

  .logo-image-dark {
    display: none;
  }

  .theme-dark .logo-image-light,
  .theme-transparent .logo-image-light {
    display: none;
  }

  .theme-dark .logo-image-dark,
  .theme-transparent .logo-image-dark {
    display: block;
  }

  .main-nav {
    flex: 1;
    display: flex;
    justify-content: center;
  }

  .nav-list {
    display: flex;
    gap: var(--space-1);
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .nav-item > a {
    display: block;
    padding: var(--space-2) var(--space-4);
    color: var(--text-muted);
    text-decoration: none;
    font-weight: 500;
    border-radius: var(--radius-md);
    transition: all var(--transition-fast);
  }

  .theme-dark .nav-item > a,
  .theme-transparent .nav-item > a {
    color: rgba(255,255,255,0.7);
  }

  .nav-item > a:hover {
    color: var(--text);
    background: var(--surface);
  }

  .theme-dark .nav-item > a:hover,
  .theme-transparent .nav-item > a:hover {
    color: white;
    background: rgba(255,255,255,0.1);
  }

  /* Dropdown */
  .has-dropdown {
    position: relative;
  }

  .dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    min-width: 220px;
    background: var(--background);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    padding: var(--space-2);
    opacity: 0;
    visibility: hidden;
    transform: translateY(8px);
    transition: all var(--transition-fast);
    list-style: none;
    margin: 0;
  }

  .has-dropdown:hover .dropdown {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .dropdown a {
    display: block;
    padding: var(--space-2) var(--space-3);
    color: var(--text-muted);
    text-decoration: none;
    border-radius: var(--radius-md);
    font-size: var(--text-sm);
  }

  .dropdown a:hover {
    color: var(--text);
    background: var(--surface);
  }

  .header-actions {
    display: flex;
    align-items: center;
    gap: var(--space-4);
  }

  /* Language Switcher */
  .lang-switch-wrapper {
    position: relative;
  }

  .lang-current {
    display: flex;
    align-items: center;
    gap: var(--space-1);
    padding: var(--space-2) var(--space-3);
    background: none;
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    color: var(--text);
    font-size: var(--text-sm);
    font-weight: 500;
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .lang-current:hover {
    border-color: var(--primary);
  }

  .theme-dark .lang-current,
  .theme-transparent .lang-current {
    border-color: rgba(255,255,255,0.2);
    color: white;
  }

  .lang-dropdown {
    position: absolute;
    top: 100%;
    right: 0;
    margin-top: var(--space-2);
    min-width: 160px;
    background: var(--background);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    padding: var(--space-2);
    list-style: none;
    opacity: 0;
    visibility: hidden;
    transform: translateY(8px);
    transition: all var(--transition-fast);
  }

  .lang-switch-wrapper:hover .lang-dropdown,
  .lang-current[aria-expanded="true"] + .lang-dropdown {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .lang-dropdown a {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-2) var(--space-3);
    color: var(--text-muted);
    text-decoration: none;
    border-radius: var(--radius-md);
    transition: all var(--transition-fast);
  }

  .lang-dropdown a:hover,
  .lang-dropdown a.active {
    color: var(--text);
    background: var(--surface);
  }

  .lang-dropdown a.active {
    font-weight: 600;
  }

  .lang-code {
    font-weight: 600;
    font-size: var(--text-sm);
  }

  .lang-name {
    font-size: var(--text-sm);
    color: var(--text-muted);
  }

  .mobile-menu-toggle {
    display: none;
    padding: var(--space-2);
    background: none;
    border: none;
    cursor: pointer;
  }

  .hamburger {
    display: block;
    width: 24px;
    height: 2px;
    background: var(--text);
    position: relative;
  }

  .hamburger::before,
  .hamburger::after {
    content: '';
    position: absolute;
    width: 100%;
    height: 100%;
    background: inherit;
    left: 0;
  }

  .hamburger::before { top: -7px; }
  .hamburger::after { top: 7px; }

  .theme-dark .hamburger,
  .theme-transparent .hamburger {
    background: white;
  }

  /* Mobile */
  @media (max-width: 1024px) {
    .main-nav {
      display: none;
    }

    .mobile-menu-toggle {
      display: block;
    }

    .header-actions .btn {
      display: none;
    }
  }

  /* ──────────────────────────────────
     Welt-Kontext-Leiste
  ────────────────────────────────── */
  :global(.world-bar) {
    position: sticky;
    top: 73px; /* Höhe des Haupt-Headers */
    z-index: 99;
    padding: 0 0;
    font-size: var(--text-sm);
    font-family: var(--font-heading);
    border-bottom: 1px solid rgba(255,255,255,0.12);
  }

  :global(.world-bar--labor) {
    background: var(--mv-violet);
  }

  :global(.world-bar--serie) {
    background: var(--mv-gray-900);
  }

  :global(.world-bar .container) {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    flex-wrap: wrap;
    padding-top: var(--space-2);
    padding-bottom: var(--space-2);
  }

  :global(.world-bar__label) {
    font-weight: 700;
    color: rgba(255,255,255,0.55);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-size: var(--text-xs);
    white-space: nowrap;
  }

  :global(.world-bar__sep) {
    color: rgba(255,255,255,0.3);
    font-size: var(--text-base);
    line-height: 1;
  }

  :global(.world-bar__links) {
    display: flex;
    align-items: center;
    gap: var(--space-1);
    list-style: none;
    margin: 0;
    padding: 0;
    flex: 1;
  }

  :global(.world-bar__links a) {
    display: block;
    padding: var(--space-1) var(--space-3);
    color: rgba(255,255,255,0.8);
    text-decoration: none;
    border-radius: var(--radius-md);
    transition: all var(--transition-fast);
    white-space: nowrap;
  }

  :global(.world-bar__links a:hover) {
    background: rgba(255,255,255,0.1);
    color: #fff;
  }

  :global(.world-bar__switch) {
    margin-left: auto;
    font-size: var(--text-xs);
    font-weight: 600;
    color: rgba(255,255,255,0.6);
    text-decoration: none;
    padding: var(--space-1) var(--space-3);
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: var(--radius-full);
    white-space: nowrap;
    transition: all var(--transition-fast);
  }

  :global(.world-bar--labor .world-bar__switch:hover) {
    border-color: var(--mv-orange);
    color: var(--mv-orange);
  }

  :global(.world-bar--serie .world-bar__switch:hover) {
    border-color: var(--mv-blue);
    color: var(--mv-blue);
  }

  @media (max-width: 640px) {
    :global(.world-bar__label),
    :global(.world-bar__sep) {
      display: none;
    }
    :global(.world-bar__switch) {
      margin-left: 0;
    }
  }
</style>

<script>
  // Mobile menu toggle
  const toggle = document.querySelector('.mobile-menu-toggle');
  const nav = document.getElementById('main-nav');

  toggle?.addEventListener('click', () => {
    const isExpanded = toggle.getAttribute('aria-expanded') === 'true';
    toggle.setAttribute('aria-expanded', (!isExpanded).toString());
    nav?.classList.toggle('is-open');
  });

  // Language dropdown
  const langBtn = document.querySelector('.lang-current');
  langBtn?.addEventListener('click', () => {
    const isExpanded = langBtn.getAttribute('aria-expanded') === 'true';
    langBtn.setAttribute('aria-expanded', (!isExpanded).toString());
  });
</script>
